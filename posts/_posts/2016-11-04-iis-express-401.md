---
layout: post
title: Certificate trouble on IIS Express
relativeroot: ../../../../
category: posts
alt_excerpt: HTTP 401 errors when calling WebAPI2 backend with IdentityServer3 authentication on IIS Express 10 resolved by fixing IIS Express self-signed certificate on development machine
---

# The Problem

I suddenly started getting unsolicited 401 errors when debugging a website backed with ASP.NET WebAPI2 (auth via IdentityServer3, using IIS Express 10 and Visual Studio 2015). I verified that the sign-in request went through as it was supposed to, the authentication token was received and the calls were being made with the correct headers in place.

After digging through the code (this happened in conjunction with a wide-spread refactoring that was not supposed to have any functional impact) I finally tested with an earlier version and found out that the problem was with the development environment instead.

Another problem that I did not pay attention to at first, was that the web browser was also rejecting the certificate (NET::ERR_CERT_AUTHORITY_INVALID in Chrome, I just clicked through the warnings to get to the site). Apparently IdentityServer3 and/or WebAPI2 authentication middleware also verifies the server certificate at some point during token validation and the certificate on my installation of IIS Express was no longer trusted.

# Attempts at Fixing the Certificate

Mostly following suggestions in here: <http://stackoverflow.com/questions/20036984/how-do-i-fix-a-missing-iis-express-ssl-certificate>.

## Repair/Reinstall IIS Express

- In Windows 10 the Repair option is not available in the "Add or Remove Programs" view, you have to go in through the Control Panel.
- Either way, the certificate is regenerated and added to all ports in the range 44300-44399
- No effect

## Repair Visual Studio Installation

- No effect

## Assign Certificate to Ports using Netsh

- List assignments: `netsh http show sslcert [ipport=0.0.0.0:<port_in_range_44300_to_44399>]`
- Deassign cert from single port: `netsh http delete sslcert [ipport=0.0.0.0:<port_in_range_44300_to_44399>]`
- Assign cert to a single port: `netsh http add sslcert ipport=0.0.0.0:<port_in_range_44300_to_44399> certhash=<cert_thumbprint_with_no_spaces> appid=
{<some_generated_guid>}`
- Clear certs from all IIS Express HTTPS ports: FOR /L %i IN (44300,1,44399) DO netsh http delete sslcert ipport=0.0.0.0:%i
- Assign cert for all IIS Express HTTPS ports: `FOR /L %i IN (44300,1,44399) DO netsh http add sslcert ipport=0.0.0.0:<port_in_range_44300_to_44399> certhash=<cert_thumbprint_with_no_spaces> appid=
{<some_generated_guid>}`
- No effect

## IisExpressAdminCmd

- `cd C:\Program Files (x86)\IIS Express`
- `IisExpressAdminCmd.exe setupsslUrl -url:https://localhost:<port_in_range_44300_to_44399>/ -UseSelfSigned`
- Regenerates the IIS Express Development certificate if missing and adds the certificate to all ports in the range 44300-44399.
- No effect

## Move the development certificate to Trusted Root Certification Authorities

- <http://www.hanselman.com/blog/WorkingWithSSLAtDevelopmentTimeIsEasierWithIISExpress.aspx>
- Drag the "IIS Express Development Certificate" (issued to localhost) from "Personal/Certificates" to "Trusted Root Certification Authorities/Certificates."
- Seemed to work at first (browser no longer complained about certificate, no more 401 errors from API calls)
- The problem reappeared when I rebooted the development machine

# Actual Cause

I suspect that the certificate setup was somehow gotten dislodged in conjunction of a Windows, Visual Studio or IIS Express update process.
However, Visual Studio did not ask to trust any new certificates created during my struggles like seen in this example: <http://www.c-sharpcorner.com/UploadFile/4b0136/a/>.

Therefore, finally, the working solution was to trust the certificate manually, which means not to move the certificate to "Trusted Root Certification Authorities" but to **_copy_** it there so that the exact same certificate is in both stores at the same time.
The easiest way to accomplish this is to browse to the site with Internet Explorer and installing the certificate from there.
Instructions: <https://blogs.msdn.microsoft.com/robert_mcmurray/2013/11/15/how-to-trust-the-iis-express-self-signed-certificate/>

It's easy when you're omniscient.
