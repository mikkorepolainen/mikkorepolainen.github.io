---
layout: post
title: Certificate trouble on IIS Express
relativeroot: ../../../../
category: posts
alt_excerpt: HTTP 401 errors when calling WebAPI2 backend with IdentityServer3 authentication on IIS Express 10 resolved by fixing IIS Express self-signed certificate on development machine
---

I suddenly started getting unsolicited 401 errors when debugging a website backed with ASP.NET WebAPI2 (auth via IdentityServer3, using IIS Express 10 and Visual Studio 2015). I verified that the sign-in request went through as it was supposed to, the authentication token was received and the calls were being made with the correct headers in place.

After digging through the code (this happened in conjunction with a wide-spread refactoring that was not supposed to have any functional impact) I finally tested with an earlier version and found out that the problem was with the development environment instead.

Another problem that I did not pay attention to at first, was that the web browser was also rejecting the certificate (I just clicked through the warnings to get to the site). Apparently IdentityServer3 and/or WebAPI2 authentication middleware also verifies the server certificate at some point during token validation and the certificate on my installation of IIS Express was no longer trusted.

I tried the following solutions to no avail: 

- Removing the certificate from the local machine and reinstalling IIS Express
- Using `netsh` to delete and reassign the development certificate to the specific SSL port
   - `netsh http delete sslcert ipport=0.0.0.0:<port_in_range_44300_to_44399>`
   - `netsh http add sslcert ipport=0.0.0.0:<port_in_range_44300_to_44399> certhash=<cert_thumbprint_with_no_spaces> appid=
{<some_generated_guid>}`
- Using `IisExpressAdminCmd` to do the same.
   - `cd C:\Program Files (x86)\IIS Express`
   - `IisExpressAdminCmd.exe setupsslUrl -url:https://localhost:<port_in_range_44300_to_44399>/ -UseSelfSigned`

Thread on SO: <http://stackoverflow.com/questions/20036984/how-do-i-fix-a-missing-iis-express-ssl-certificate>

And finally I stumbled on Hanselman's age-old post here <http://www.hanselman.com/blog/WorkingWithSSLAtDevelopmentTimeIsEasierWithIISExpress.aspx>

The solution for me was to just drag the "IIS Express Development Certificate" (issued to localhost) from "Personal/Certificates" to "Trusted Root Certification Authorities/Certificates."

It's easy when you're omniscient.
