---
layout: document
title: Docker Notes
description: General docker notes. This document will eventually evolve and branch out to multiple documents.
modified: 2016-05-01 23:59:00
relativeroot: ../../
permalink: documents/docker
type: document
tags:
- Docker
- KVM
- Containers
category: documents
published: true
hidden: true
---

Installing Docker
===========

Linux
------

Quick install: `curl -sSL https://get.docker.com/ | sh`

Add user to docker group for use without sudo:

- `sudo usermod -aG docker <user>`
- Restart the docker service (e.g. `sudo service docker restart` on Ubuntu)
- Log out and back in again.

Removing:

{% highlight bash %}
apt-get purge docker-engine
apt-get autoremove --purge docker-engine
rm -rf /var/lib/docker
{% endhighlight %}

Note that the last command removes also all volumes and configuration data from containers.

Windows & Mac OS
----------------------

Download and install [docker toolbox](https://www.docker.com/products/docker-toolbox).
The toolbox contains the docker tools (including docker-machine and docker-compose), Kitematic (an UI for managing containers) and Oracle VirtualBox installer.

If you don't plan to run containers on top of a local VirtualBox instance, then you can leave VirtualBox unchecked in the installer (e.g. if you plan to use Hyper-V on windows).

### Local Container Host for Development

Running Kitematic spins up a new local VM called `default` on top of VirtualBox.
At the time of writing, the Kitematic UI only supports the VirtualBox driver and a local VM called `default`
(you can have a stab at the kitematic source code and compile it yourself though, see [here](http://agup.tech/2015/08/14/hacking-at-kitematic-with-hyper-v-on-windows-10/))).

Alternatively, you can run `docker-machine create --driver <driver name> <VM name>` on the command line followed by `docker-machine start <VM name>`.
See more on the `docker-machine` command line tool in section [Docker Machine](#Docker_Machine).

Managing Docker hosts
====================

Docker Machine
-----------------------

Resources:

- [Official documentation](https://docs.docker.com/machine/)

Docker Machine can be used to quickly provision virtual machines for use as docker hosts.
There is a selection of drivers available for both local and remote virtualization hosts/providers.
Check the [official documentation](https://docs.docker.com/machine/drivers/) for a list of available drivers and driver-specific documentation.

TODO Suitability for production use?

### Installation

On linux, the docker-machine binary is a separate install (the docker toolbox contains docker-machine by default).
Check the latest version in [https://github.com/docker/machine/releases](https://github.com/docker/machine/releases) and follow the instructions, e.g.:

{% highlight bash %}
curl -L https://github.com/docker/machine/releases/download/v0.7.0/docker-machine-`uname -s`-`uname -m` >/usr/local/bin/docker-machine
chmod +x /usr/local/bin/docker-machine
{% endhighlight %}

### Creating VMs

Docker Machine supports a variety of drivers (local or remote).
The default operating system on the virtual machines depends on the driver.
On local instances, the OS is installed by default from the latest boot2docker.iso from [github](https://github.com/boot2docker/boot2docker/releases/).
A flavor of Ubuntu is installed by default on remote hosts.
Some drivers allow the image to be changed.

Check the [official documentation](https://docs.docker.com/machine/drivers/) for a list of available drivers and driver-specific documentation.
Run `docker-machine create --driver <driver name> -h` for a list of supported driver-specific parameters.

#### Creating a local VM on VirtualBox

`docker-machine create --driver virtualbox <VM Name>`

TODO bridged networking

For more options, refer to the [documentation](https://docs.docker.com/machine/drivers/virtualbox/).

#### Creating a local VM on Hyper-V

Follow the instructions [here](https://stebet.net/installing-docker-tools-on-windows-using-hyper-v/) and [here](https://blogs.technet.microsoft.com/canitpro/2014/03/10/step-by-step-enabling-hyper-v-for-use-on-windows-8-1/).

In a nutshell, you must create a virtual network switch in Hyper-V Manager (local machine -> Virtual Switch Manager... -> New virtual network switch). Select the External virtual switch type and click Create Virtual Switch. Give the switch a name and make sure the External network selected under Connection Type is the correct physical network adapter.

Then run `docker-machine create --driver=hyperv default` as administrator.

For more options, refer to the [documentation](https://docs.docker.com/machine/drivers/hyper-v/).

#### Creating a local VM on KVM

Using docker-machine with KVM requires a third party driver, e.g.: [docker-machine-kvm](https://github.com/dhiltgen/docker-machine-kvm).
(For setting up a KVM environment, see [Virtualization With KVM]({% post_url 2015-10-07-virtualization-with-kvm %}).)

{% highlight bash %}
apt-get install libvirt-go
curl -L https://github.com/dhiltgen/docker-machine-kvm/releases/download/v0.6.0/docker-machine-driver-kvm > /usr/local/bin/docker-machine-driver-kvm
chmod +x /usr/local/bin/docker-machine-driver-kvm
{% endhighlight %}

Creating a VM: `docker-machine create --driver kvm --kvm-cpu-count 1 --kvm-disk-size 20000 --kvm-memory 1024 <VM name>`

To expose the VM to the surrounding network by connecting the VM to an existing host bridge, add `--kvm-network <network name>` to the above command, where `network name` is the name of a host bridge added as a virtual network or reconfigure networking after creating the VM.
See [Virtualization With KVM]({% post_url 2015-10-07-virtualization-with-kvm %}#Bridged_Networking_Create_a_Virtual_Network_Using_the_Existing_Bridge).

The VM created this way has two network interfaces, one in the docker-machines network and the other on the virtual bridge or the specified network. The `docker-machine ip <VM name>` command returns the ip address in the docker-machines network.
To find out the bridged ip address of the VM, use `docker-machine ssh <VM name> "ip -one -4 addr show dev eth0|cut -f7 -d' '"`

#### Generic

Use this driver to control hosts with no direct support in docker-machine.

TODO example

For more options, refer to the [documentation](https://docs.docker.com/machine/drivers/generic/).

### Removing a VM

`docker-machine rm <VM name>`

### Using the Docker Host

To find out the ip address of the VM, use `docker-machine ip <VM name>`.

NOTE: The host name of the VM seems to be `boot2docker` when first created, bridged to a network that uses DHCP for DNS.
Rebooting the VM seems to rectify the issue.

On linux you need to do `eval $(docker-machine env <VM name>)` to set up the command line environment to point to the correct instance for subsequent docker commands.

On windows the corresponding command is `@FOR /f "tokens=*" %i IN ('docker-machine env <VM name>') DO @%i`

### Commands

- `docker-machine ls` list VMs created using docker-machine on the current host
- `docker-machine ip <VM Name>` get ip address of VM
- `docker-machine ssh <VM Name>` ssh access
- `docker-machine inspect <VM Name>` machine information
- `docker-machine start <VM Name>` start
- `docker-machine stop <VM Name>` stop
- `docker-machine restart <VM Name>` restart
- `docker-machine kill <VM Name>` kill
- `docker-machine rm <VM Name>` remove

See more information in [docker-machine reference](https://docs.docker.com/machine/reference/).
